---
title: 'Unit And Integration Test Reports For Maven Projects In SonarQube 4.5.1'
date: 2015-01-30
#description: "Article description." # Description used for search engine.
featured: false # Sets if post is a featured post, making appear on the home page side bar.
draft: false # Sets whether to render this page. Draft of true will not be rendered.
toc: false # Controls if a table of contents should be generated for first-level links automatically.
# menu: main
#featureImage: "/images/path/file.jpg" # Sets featured image on blog post.
#thumbnail: "/images/path/thumbnail.png" # Sets thumbnail image appearing inside card on homepage.
#shareImage: "/images/path/share.png" # Designate a separate image for social media sharing.
#codeMaxLines: 10 # Override global value for how many lines within a code block before auto-collapsing.
codeLineNumbers: false # Override global value for showing of line numbers within code block.
figurePositionShow: true # Override global value for showing the figure label.
categories:
  - Continuous Integration
  - Java
  - Maven
  - SonarQube
  - Testing
tags:
  - integration-testing
  - jacoco
  - maven
  - sonarqube
  - test-coverage
  - test-report
  - unit-testing


# comment: false # Disable comment if false.
---

Since SonarQube 4.2. the test report isn't generated by the Sonar Maven Plugin during a Maven build (see [SonarQube's blog post](http://www.sonarqube.org/unit-test-execution-in-sonarqube/)) . Therefore, the test report has to be generated by another plugin before Sonar Maven Plugin collects the information for the SonarQube server. Here, Jacoco Maven Plugin can help. It has the possibility to generate test report that are understandable for SonarQube. Jacoco Maven Plugin goes one step further, it has the possibility to generate a test report for integration test.

In the following sections, a solution is presented that meets following criteria:

*   Maven is used as build tool.
*   The project can be a multi module project.
*   Unit tests and integration tests are parts of each module. Here, integration tests are tests that test the integration between classes in a module.
*   Test reports are separate in unit test report and integration test report.

The road map for the next section is that firstly the Maven project structure is shown for the separation of unit and integration tests. Then the Maven project configuration is shown for having separate unit test runs and integration test runs.  After that, we have a look on the Maven project configuration for the test report generation separated in unit test and integration test. At the end, SonarQube's configuration is shown for the test report visualization in the SonarQube's dashboard.

Maven Project Structure
-----------------------

At first, we look at how a default Maven project structure looks like for a single module project.

```shell
my-app
├── pom.xml
├── src
│   ├── main
│   │   └── java
│   └── test
│       └── java
```

The directory `src/main/java` contains the production source code and the directory `src/test/java` contains the test source code. We could put unit tests and integration tests together in this directory. But we want to separate these two types of tests in separate directories. Therefore, we add a new directory called `src/it/java.` Then unit tests are put in the directory `src/test/java` and the integration tests are put in the directory `src/it/java,` so the new project structure looks like the following one.

```shell
my-app
├── pom.xml
├── src
│   ├── it
│   │   └── java
│   ├── main
│   │   └── java
│   └── test
│       └── java
```

Unit And Integration Test Runs
------------------------------

Fortunately, the unit test run configuration is a part of the Maven default project configuration. Maven runs these tests automatically if following criteria are met:

*   The tests are in the directory `src/test/java` and
*   the test class name either starts with `Test` or ends with `Test` or `TestCase.`

Maven runs these tests during the [Maven's build lifecylce](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html) phase `test.`

The integration test run configuration has to be done manually. It exists Maven plugins that can help. We want that the following criteria are met:

*   integration tests are stored in the directory `src/it/java` and
*   the integration test class name either starts `IT` or ends with `IT` or `ITCase` and
*   integrations tests runs during the Maven's build lifecycle phase `integration-test.`

Firstly, Maven has to know that it has to include the directory `src/it/java` to its test class path. Here, the Build Helper Maven Plugin can help. It adds the directory `src/it/java` to the test class path.

```xml
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>build-helper-maven-plugin</artifactId>
                <version>1.8</version>
                <executions>
                    <execution>
                        <id>add-test-source</id>
                        <phase>process-test-sources</phase>
                        <goals>
                            <goal>add-test-source</goal>
                        </goals>
                        <configuration>
                            <sources>
                                <source>src/it/java</source>
                            </sources>
                        </configuration>
                    </execution>
                    <execution>
                        <id>add-test-resources</id>
                        <phase>generate-test-resources</phase>
                        <goals>
                            <goal>add-test-resource</goal>
                        </goals>
                        <configuration>
                            <resources>
                                <resource>
                                    <directory>src/it/resources</directory>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
```

The above code snippet has to be inserted into the section `<project><build><plugins>` in the project root pom.

Maven's build lifecycle contains a phase called `integration-test.` In this phase, we want to run the integration test. Therefore, we bind the Maven Failsafe Plugin to the phase `integration-test:`

```xml
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <version>2.13</version>
                <configuration>
                    <encoding>${project.build.sourceEncoding}</encoding>
                </configuration>
                <executions>
                    <execution>
                        <id>failsafe-integration-tests</id>
                        <phase>integration-test</phase>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
```

Again, the above code snippet also has to be inserted into the section `<project><build><plugins>` in the project root pom. Then Maven Failsafe Plugin runs the integration tests automatically, when their class name either starts with `IT` or ends with `IT `or `ITCase.`

Test Report Generation
----------------------

We want to use the Jacoco Maven Plugin for the test report generation. It should generate two test reports, one for the unit test and one for the integration tests. Therefore, the plugin has to two separated agents, that have to be prepared. Then they generate the report during the test runs. The Maven's build lifecycle contains own phases for preparation before the test phases (`test` and `integration-test`). The preparation phase for the `test` phase is called `process-test-classes` and the preparation phase for `integration-test` phase is called `pre-integration-test`. In these two phases we bind the Jacoco Maven Plugin, so the configuration of this plugin looks like the following code snippet (Again, it is a part of the section `<project><build><plugins>`):

```xml
            <plugin>
                <groupId>org.jacoco</groupId>
                <artifactId>jacoco-maven-plugin</artifactId>
                <version>0.7.2.201409121644</version>  
                <executions>    
                    <execution>  
                        <configuration>  
                            <destFile>${sonar.jacoco.reportPath}</destFile>  
                        </configuration>  
                        <id>pre-test</id>
                        <phase>process-test-classes</phase>  
                        <goals>  
                            <goal>prepare-agent</goal>  
                        </goals>  
                    </execution>  
                    <!-- we want to execute jacoco:prepare-agent-integration in test phase,  
                    but before executing maven failsafe plugin -->  
                    <execution>  
                        <configuration>  
                            <destFile>${sonar.jacoco.itReportPath}</destFile>  
                        </configuration>  
                        <id>pre-itest</id>
                        <phase>pre-integration-test</phase>  
                        <goals>  
                            <goal>prepare-agent-integration</goal>  
                        </goals>  
                    </execution>  
                </executions>  
            </plugin>
```

The configuration element `destFile` is the path to the location, where the test reports should be stored. It is important to use the properties `${sonar.jacoco.reportPath}` and `${sonar.jacoco.itReportPath}`. These properties are used by SonarQube to find the test reports for the visualization.

Now, we can run the goal `mvn install` and our project is built inclusive unit and integration test and inclusive generating two test reports.

SonarQube Test Report Visualization
-----------------------------------

Now, we want to visualize our test reports in SonarQube. Therefore, we have to run the Sonar Maven 3 Plugin (command `mvn sonar:sonar`)  in our project after a successful build.

When we open our project in the SonarQube dashboard, we see only the report for the unit test per module. The reason is that the report visualization of the integration test has to be configured in SonarQube, separately. These configuration steps are described in the [SonarQube documentation](http://docs.sonarqube.org/display/PLUG/Code+Coverage+by+Integration+Tests+for+Java+Project) very well.

Summary
-------

This blog describes how to generate test reports for unit and integration test during a Maven build. On [GitHub](https://github.com/skosmalla/sonarqube-test-report-with-maven), I host a sample project that demonstrate all configuration steps. As technical environment I use

*   Maven 3.2.5
*   Maven Plugins:
    *   Maven Surefire Plugin
    *   Maven Failsafe Plugin
    *   Build Helper Maven Plugin
    *   Jacoco Maven Plugin
    *   Sonar Maven 3 Plugin
*   SonarQube 4.5.1
*   Java 7

Links
-----

1.  SonarQube's blog post [Unit Test Execution in SonarQube](https://docs.sonarqube.org/display/SONARQUBE45/Code+Coverage+by+Integration+Tests+for+Java+Project)
2.  Jacoco Maven plugin [project site](http://www.eclemma.org/jacoco/trunk/doc/maven.html)
3.  Introduction to Maven's build lifecycle
4.  Maven Failsafe Plugin  [project site](http://maven.apache.org/surefire/maven-failsafe-plugin/index.html)
5.  Build Helper Maven Plugin [project site](http://mojo.codehaus.org/build-helper-maven-plugin/)
6.  SonarQube documentation about [Code Coverage by Integration Tests for Java Project](http://docs.sonarqube.org/display/PLUG/Code+Coverage+by+Integration+Tests+for+Java+Project)
7.  A sample Maven project on [GitHub](https://github.com/sparsick/sonarqube-test-report-with-maven/tree/sonarqube-4.5.1)
